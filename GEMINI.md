# プロジェクト概要: 競馬予想Pythonプログラム

このプロジェクトは、Pythonを使用して競馬のレース結果を予測し、馬券の推奨を行うためのプログラムです。データ収集、予測モデルの構築、および予測結果の評価という一連のプロセスをカバーしています。

## 1. 目的

*   netkeiba.comから競馬関連データを自動的に収集する。
*   収集したデータと過去のレース結果を基に、各出走馬の総合スコアを算出する。
*   算出されたスコアに基づいて、レースの予測（特に単勝、複勝、ワイド馬券の推奨）を行う。
*   予測モデルの精度を評価し、改善のためのフィードバックを得る。
*   **目標**: ワイド馬券の的中率50%以上を目指す（計算式: (的中ワイド馬券数 / (評価レース数 * 3)) * 100）。

## 2. 主要な機能とファイル構成

### `main.py` (メイン処理/オーケストレーター)
プログラムの実行起点となるファイルです。
*   指定されたレースURLからレース情報を取得します。
*   `scraping.py`を呼び出して出馬表データを取得します。
*   `scorer.py`を呼び出して各出走馬のスコアを計算します。
*   計算されたスコアに基づいて、上位馬を選出し、単勝、複勝、ワイドの推奨組み合わせを生成します。

*   **追加変更点**: `get_horse_total_score`の呼び出しに、`futan`, `weight`, `weight_sa`, `wakuban`, `odds`, `corner`, `kyaku`, `time`, `pace`, `harontimel3`, `chakusa`, `sex`, `age`, `blinker`, `norikawari`, `trainer_syozoku`, `owner_cd`, `lap_times`の各パラメータを渡すように変更しました。

### `data_fetcher.py` (データ取得)
netkeiba.comから様々な競馬関連データを取得するためのモジュールです。
*   **`get_horse_data(horse_id)`**: 特定の競走馬の過去のレース結果と血統情報（父、母）を取得します。
*   **`get_horse_course_aptitude(horse_id)`**: 競走馬のコース別成績を取得します。
*   **`get_jockey_leading_data(year)`**: 指定された年の騎手リーディングデータ（勝率、連対率など）をキャッシュ機能付きで取得します。
*   **`get_jockey_course_aptitude(jockey_id)`**: 騎手のコース別成績を取得します。
*   **`get_sire_course_aptitude(sire_id)`**: 種牡馬のコース別成績を取得します。
*   **`get_bms_course_aptitude(bms_id)`**: 母の父（ブルードメアサイアー）のコース別成績を取得します。

### `evaluate.py` (評価)
予測モデルの性能を評価するためのスクリプトです。
*   `pastRace.txt`に記載された過去のレースURLを読み込みます。
*   各レースに対して`main.py`を呼び出して予測を実行します。
*   実際のレース結果（上位3着馬）をスクレイピングして取得します。
*   予測結果と実際の結果を比較し、単勝、複勝、ワイドの的中率を計算・表示します。
*   `get_actual_payouts`関数を修正し、配当テーブルを正しく解析できるようにしました。
*   推奨馬券と実際の結果の表示を追加しました。
*   仮検証と本格評価のロジックが含まれています。

### `get_past_races.py` (過去レースURL取得)
Seleniumを使用してnetkeiba.comから特定の年の過去レース結果URLを収集し、テキストファイルに保存します。これは`evaluate.py`の入力データとして使用されます。

### `scorer.py` (スコア計算ロジック)
各出走馬の総合スコアを算出する中心的なロジックが実装されています。以下の要素を考慮してスコアを計算します。
*   **過去のパフォーマンス**: 着順、着差、上がり3ハロンタイム、レースからの経過日数（Recency Decay）を考慮します。
*   **人気**: 予想人気順位に基づいてスコアを加算します。
*   **騎手**: 騎手の年間リーディングデータ（勝率、連対率）をスコアに反映します。
*   **コース適性**: 競走馬、騎手、種牡馬、母の父それぞれのコース別成績をスコアに反映します。
*   **血統**: 父馬と母馬のスコアを再帰的に計算し、その一部を子馬のスコアに加算します。
*   **忖度ロジック**: 出走回数が少ないが平均スコアが高い馬に対して、潜在的な能力を評価するための調整を行います。
*   **追加されたスコアリング要素**:
    *   `WAKUBAN_SCORES`: 枠番によるスコア。
    *   `FUTAN_KG_BASE`, `FUTAN_SCORE_MULTIPLIER`: 斤量によるスコア。
    *   `WEIGHT_CHANGE_SCORE_MAP`: 馬体重変化によるスコア。
    *   `ODDS_SCORE_MULTIPLIER`: オッズによるスコア。
    *   `CORNER_POSITION_BONUS`: コーナー通過順位によるボーナス。
    *   `KYAKU_SCORE_MAP`: 脚質によるスコア。
    *   `TIME_SCORE_MULTIPLIER`: 走破タイムによるスコア。
    *   `PACE_SCORE_MAP`: ペースによるスコア。
    *   `harontimel3`: 上がり3ハロンタイムによるスコア。
    *   `chakusa`: 着差によるスコア。
    *   `sex`, `age`: 性別と年齢によるスコア。
    *   `blinker`: ブリンカー着用によるスコア。
    *   `norikawari`: 騎手乗り替わりによるスコア。
    *   `trainer_syozoku`: 調教師の所属によるスコア。
    *   `owner_cd`: 馬主コードによるスコア。
*   **追加された関数**: `calculate_odds_score`, `calculate_corner_score`, `calculate_kyaku_score`, `calculate_time_score`, `calculate_pace_score`, `calculate_sex_age_score`, `calculate_haron_time_score`, `calculate_chakusa_score`。
*   `get_horse_total_score`関数は、これらの新しい要素をスコア計算に組み込み、再帰呼び出し時に新しい引数に`None`を渡せるように変更されました。

## 3. データフロー

1.  **過去レースURLの収集**: `get_past_races.py`がSeleniumを用いてnetkeiba.comから過去のレース結果URLを収集し、`pastRace.txt`に保存します。
2.  **出馬表データの取得**: `main.py`が実行されると、`scraping.py`を介して対象レースの出馬表データがnetkeiba.comから取得され、`shutuba_YYYYMMDDXXXX.csv`として保存されます。
3.  **詳細データの取得**: `scorer.py`がスコア計算のために、`data_fetcher.py`を介して各出走馬の過去成績、血統、騎手情報、コース適性などの詳細データをnetkeiba.comから取得します。
4.  **スコア計算**: `scorer.py`が取得した全てのデータと定義されたロジックに基づいて、各出走馬の総合スコアを算出します。
5.  **予測と推奨**: `main.py`が算出されたスコアを基に馬をランク付けし、単勝、複勝、ワイドの推奨組み合わせを生成します。
6.  **モデル評価**: `evaluate.py`が`pastRace.txt`のURLと`main.py`の予測機能を利用し、実際のレース結果と比較することでモデルの的中率を評価します。

## 4. 実行方法

*   **予測の実行**: `python main.py <レースページのURL>`
*   **過去レースURLの収集**: `python get_past_races.py <レース名>` (例: `python get_past_races.py "日本ダービー"`)。
*   **モデルの評価**: `python evaluate.py`

## 5. 評価アルゴリズムの改善履歴

1. `scorer.py`の`parse_margin`関数を修正し、`eval()`の使用を廃止し、分数表記の着差を安全に数値に変換するように変更しました。また、「クビ」「アタマ」「ハナ」などの僅差の着差に具体的な数値（秒）を割り当て、数値として扱えるようにしました。
2. `scorer.py`の`calculate_past_performance_score`関数において、`margin_adjustment`の計算ロジックを強化しました。これにより、1着馬との着差が小さい場合に、より段階的かつ大きなボーナスが加算されるようになります。特に僅差の着順に対して、より高い評価を与えるように調整しました。
3. `scorer.py`の`RANK_SCORES`を調整し、1位のスコアを大幅に引き上げ、上位着順の馬にさらに大きな重みを与えるように変更しました。
4. `scorer.py`の`POPULARITY_SCORES`を調整し、上位人気の馬にさらに高いスコアが与えられるように変更しました。
5. `scorer.py`の`jockey_score`の計算において、勝率の重みをさらに引き上げ、騎手の勝率が予測に与える影響を強化しました。
6. `scorer.py`のコース適性スコアの計算において、勝率の重みをさらに引き上げ、コース適性の勝率が予測に与える影響を強化しました。
7. `scorer.py`の`MAX_MARGIN_BONUS`を調整し、僅差の着順に対するボーナスをさらに引き上げました。
8. `main.py`の三連複推奨組み合わせ生成ロジックを修正しました。
    - 推奨枚数を15枚に増やしました。
    - スコア上位8頭から組み合わせを生成します。
    - 各馬が推奨組み合わせに登場する回数をカウントし、最も登場回数の多い馬が推奨組み合わせ全体の2/3を超えないように制限を設けました。これにより、特定の馬に依存しすぎるリスクを軽減します。
    - 組み合わせは、含まれる馬のスコア合計が高い順に優先して選定されます。

